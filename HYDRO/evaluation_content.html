
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Évaluation FFESSM - Niveau 2</title>
  <style>
    body { font-family: Arial, sans-serif; }
    table { border-collapse: collapse; width: 100%; margin-bottom: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    th { background-color: #f0f0f0; }
    td.state-A { background-color: #b6f1c2; }
    td.state-ECA { background-color: #f9b5b5; }
    td.state-NT { background-color: #ddd; }
    td.state-orange { background-color: #ffe4b2; }
    td.label-left { text-align: left; font-weight: bold; color: #004466; background: #e0e0e0; }
    .pe40-header { background-color: #0F4166; color: white; font-weight: bold; text-align: left; padding-left: 10px; }
    .commune-header { background-color: #546B8D; color: white; font-weight: bold; text-align: left; padding-left: 10px; }
    .pa20-header { background-color: #B1B8CB; color: black; font-weight: bold; text-align: left; padding-left: 10px; }
    .remarks-row textarea { width: 100%; font-size: 0.9em; box-sizing: border-box; resize: vertical; height: 8em; }
    td[data-ipdcell] { cursor: pointer; text-decoration: underline; color: darkblue; }
    .date-row input[type="date"], .evaluateur-row select { width: 100%; box-sizing: border-box; font-size: 0.9em; text-align: center; }
  </style>
</head>
<body>
<h1>Évaluation FFESSM</h1>
<select id="studentSelect">
  <option value="">-- Choisir un élève --</option>
  <option value="1">AINS Mathieu</option>
  <option value="2">BARTHELEMY Carole</option>
  <option value="3">BRAOUDE Dominique</option>
  <option value="4">DE VITI Gaétan</option>
  <option value="5">EHRHARD Virginie</option>
  <option value="6">EISNITZ Anne-Laure</option>
  <option value="7">LEPARMENTIER Damien</option>
  <option value="8">MORGAND Claire</option>
  <option value="9">OPIN Maxime</option>
  <option value="10">OURSEL Oxana</option>
  <option value="11">PINHEIRO Tony</option>
  <option value="12">RONDET Célian</option>
</select>

<!-- Tableau d'évaluation fictif simplifié pour illustration -->
<table>
  <tr><th>Compétence</th><th>P1</th><th>P2</th><th>P3</th></tr>
  <tr class="pe40-header"><td colspan="4">Compétences PE40</td></tr>
  <tr><td class="label-left">Ventilation & consommation</td><td></td><td></td><td></td></tr>
  <tr><td class="label-left">Intervention sur équipier</td><td></td><td></td><td></td></tr>

  <tr class="commune-header"><td colspan="4">Compétences Communes</td></tr>
  <tr><td class="label-left">Lestage adapté</td><td></td><td></td><td></td></tr>
  <tr><td class="label-left">Vidage de masque</td><td></td><td></td><td></td></tr>

  <tr class="pa20-header"><td colspan="4">Compétences PA20</td></tr>
  <tr><td class="label-left">Parachute</td><td></td><td></td><td></td></tr>
  <tr><td class="label-left">IPD1 - Intervenir en relai</td><td data-ipdcell="IPD1-P1">Noter IPD</td><td data-ipdcell="IPD1-P2">Noter IPD</td><td data-ipdcell="IPD1-P3">Noter IPD</td></tr>
</table>

<!-- Modale IPD -->
<div id="ipdModal" style="display:none; position:fixed; top:10%; left:20%; background:#fff; border:2px solid #ccc; padding:20px; z-index:9999; max-width:60%; box-shadow:0 0 15px rgba(0,0,0,0.5)" data-cell-ref="">
  <div id="ipdContent"></div>
</div>

<script>
const criteresIPD = [
  { nom: "Interprétation du signe et comportement adapté", poids: 2 },
  { nom: "Vitesse de réaction", poids: 2 },
  { nom: "Communication décollage", poids: 2 },
  { nom: "Décollage tonique", poids: 2 },
  { nom: "Prise sécurisante et confort", poids: 3 },
  { nom: "Vitesse de remontée", poids: 5 },
  { nom: "Ralentissement à 5m", poids: 1 },
  { nom: "Stop franc 5-3m", poids: 3 },
  { nom: "Tour d’horizon", poids: 1 },
  { nom: "Regard et présence", poids: 1 }
];

document.querySelectorAll("td[data-ipdcell]").forEach(td => {
  td.addEventListener("click", () => toggleIPDModal(td.getAttribute("data-ipdcell")));
});

function toggleIPDModal(ref) {
  const modal = document.getElementById("ipdModal");
  const content = document.getElementById("ipdContent");
  modal.style.display = "block";
  modal.setAttribute("data-cell-ref", ref);

  let html = `<h3>Notation IPD : ${ref}</h3><table><tr><th>Critère</th><th>Note</th></tr>`;
  criteresIPD.forEach((c, i) => {
    html += `<tr><td>${c.nom} (/ ${c.poids})</td><td><select data-poids="${c.poids}" onchange="majTotalIPD()">${[...Array(c.poids + 1).keys()].map(n => `<option value="${n}">${n}</option>`).join('')}</select></td></tr>`;
  });
  html += `</table><br>`;
  html += `<label><input type='checkbox' class='elimCheckbox'> Intervention du moniteur</label><br>`;
  html += `<label><input type='checkbox' class='elimCheckbox'> Descente > 2m</label><br>`;
  html += `<label><input type='checkbox' class='elimCheckbox'> Percée de surface</label><br>`;
  html += `<br><label><input type='checkbox' id='ipdNotWorked'> IPD non travaillée</label><br><br>`;
  html += `Total : <span id='ipdTotal'>0</span>/20<br><br>`;
  html += `<button onclick="enregistrerIPD('${ref}')">Enregistrer</button>`;
  content.innerHTML = html;
}

function majTotalIPD() {
  let total = 0;
  document.querySelectorAll("#ipdContent select").forEach(sel => {
    total += parseInt(sel.value || 0);
  });
  document.getElementById("ipdTotal").innerText = total;
}

function enregistrerIPD(ref) {
  const cell = document.querySelector(`[data-ipdcell="${ref}"]`);
  const total = parseInt(document.getElementById("ipdTotal").innerText);
  const elim = document.querySelectorAll(".elimCheckbox:checked").length > 0;
  const notWorked = document.getElementById("ipdNotWorked").checked;
  cell.className = "";

  if (notWorked) {
    cell.innerText = "NT";
    cell.classList.add("state-NT");
  } else if (elim) {
    cell.innerText = "Éliminatoire";
    cell.classList.add("state-ECA");
  } else {
    cell.innerText = `${total}/20`;
    if (total < 10) cell.classList.add("state-ECA");
    else if (total < 15) cell.classList.add("state-orange");
    else cell.classList.add("state-A");
  }

  document.getElementById("ipdModal").style.display = "none";
}
</script>
</body>
</html>
